#! /usr/bin/env bash

# Bash wrapper to trim JSON files on the fly and compare with jd -color
# Usage: json-diff.sh <json_file1> <json_file2> [jq_filter]
# Default filter: .deliveryItems[:2000]

set -e

# Configuration
JQ_FILTER="${3:-.deliveryItems[:2000]}"
JSON_FILE1="$1"
JSON_FILE2="$2"

# Validate inputs
if [[ -z "$JSON_FILE1" || -z "$JSON_FILE2" ]]; then
    echo "Usage: $0 <json_file1> <json_file2> [jq_filter]"
    echo "Example: $0 aws-sorted.json gcp-sorted.json '.deliveryItems[:2000]'"
    echo "Default filter: .deliveryItems[:2000]"
    exit 1
fi

# Create temporary files
TEMP_FILE1=$(mktemp)
TEMP_FILE2=$(mktemp)

# Cleanup on exit
cleanup() {
    rm -f "$TEMP_FILE1" "$TEMP_FILE2"
}
trap cleanup EXIT

# Trim JSON files and write to temp files
echo "Processing $JSON_FILE1..."
jq "$JQ_FILTER" "$JSON_FILE1" > "$TEMP_FILE1"

echo "Processing $JSON_FILE2..."
jq "$JQ_FILTER" "$JSON_FILE2" > "$TEMP_FILE2"

echo "Comparing with jd..."
jd -color "$TEMP_FILE1" "$TEMP_FILE2"
